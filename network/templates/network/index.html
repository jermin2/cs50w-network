{% extends "network/layout.html" %}
{% load static %}

{% block body %}

    <style>
        textarea {
            width:100%;
        }

        #followers {
        margin:20px;
        }

        table {
            width:100%;
        }

        #follow-btn #unfollow-btn {
            margin-left:20%
        }

        #user-div, #new-post-div {
            display:none;
        }

        .content {
            background-color:white;
        }

        .content-display-only {
            border-style:none;
        }

    </style>
    {{ request.user.id|json_script:"user_id" }}
    <div class="container mt-3" id="user-div">
        <div>
            <h3 id="user-username">Author</h3>
            <div id="user-email" class="text-muted">author@email.com</div>
            <input type="text" id="user-id" value="{{author.id}}" hidden>
        </div>
        <hr />
        <table>
            <tr>
                <td class="h4 text-muted">Followers</td>
                <td class="h4 text-muted">Follows</td>
            </tr>
            <tr>
                <td class="h4"><div id="user-followers" style="display:inline-block">0 </div>
                    <button id="follow-btn" onClick="follow(true)" class="btn btn-primary" style="display:none">Follow</button>
                    <button id="unfollow-btn" onClick="follow(false)" class="btn btn-primary" style="display:none">UnFollow</button>
                    </td>
                <td id="user-following" class="h4">1</td>
            </tr>
        </table>
        <hr />
    </div>

    <div class="posts-view container" id="new-post-div" style='display:{{user.is_authenticated|yesno:"block,none"}}'>
        <div class="post" >
            <h2>New Post</h2>
            <textarea id="new-post-content"></textarea>
            <button id="new-post-btn" class="btn btn-primary">Post</button>
        </div>
    </div>

    <div class="posts-view container" id="posts-view">
        All the other posts will appear here
    </div>


    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center" id="pagination">
          <li class="page-item disabled">
            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
          </li>
          <li class="page-item"><a class="page-link" href="#">1</a></li>
          <li class="page-item"><a class="page-link" href="#">2</a></li>
          <li class="page-item"><a class="page-link" href="#">3</a></li>
          <li class="page-item">
            <a class="page-link" href="#">Next</a>
          </li>
        </ul>
      </nav>



{% endblock %}


{% block script %}

    <script>
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log("All loaded")
        
            document.querySelector("#new-post-btn").onclick = () => {
                new_post()
                return false
            }

            document.querySelector("#all-posts-btn").onclick = () => {
                fetch_posts()
                return false
            }

            document.addEventListener('click', event => {
                // Find what element was clicked on
                const element = event.target

                // If we clicked on an edit button
                if (element.classList.contains("edit") ){

                    // Make textarea editable and show border
                    const ta = element.parentElement.parentElement.querySelector("textarea")
                    ta.disabled = false
                    ta.classList.remove("content-display-only")

                    // show save button
                    element.style.display = "none"
                    element.parentElement.querySelector(".save").style.display = "inline-block"
                }
                if (element.classList.contains("save") ){

                    // Get the parent div element for the meta information
                    const parent = element.parentElement.parentElement

                    // Get user_id
                    const user_id = JSON.parse(document.getElementById('user_id').textContent);

                    // Get the text area element 
                    const ta = parent.querySelector("textarea")

                    // Front-end check for author
                    if(parent.dataset.author_id != user_id) {
                        console.log("You are not author!")
                        return
                    }

                    // Send the Json request containing post_id, and content
                    fetch('/edit_post', {
                    method: 'POST',
                    body: JSON.stringify({
                        post_id: parent.dataset.post_id,
                        content: ta.value
                    })
                    })
                    .then(response => response.json())
                    .then(result => {
                        // Print result
                        ta.value = result.content

                    });

                    // Make textarea uneditable and hide border
                    ta.disabled = true
                    ta.classList.add("content-display-only")

                    // show edit button
                    element.style.display = "none"
                    element.parentElement.querySelector(".edit").style.display = "inline-block"
                }

                
            })
            
            
            // by default, load all the posts
            fetch_posts()

        })
    </script>
    <script src="{% static 'network/network.js' %}?v=4"></script>
{% endblock %}